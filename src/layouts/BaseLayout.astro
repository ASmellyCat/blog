---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = 'coconut的梦游仙境 — A personal blog' } = Astro.props;
---

<!doctype html>
<html lang="en" class="scanlines">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={`${import.meta.env.BASE_URL}favicon.svg`} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#050510" />
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500&family=Orbitron:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@100;300;500;900&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen bg-[var(--color-bg)] text-[var(--color-text)]">
    <!-- Cyberpunk Splash Screen -->
    <div id="splashScreen" class="splash-screen">
      <div class="splash-content">
        <div class="splash-glitch" data-text="COCONUT的">COCONUT的</div>
        <div class="splash-subtitle">梦游仙境</div>
        <div class="splash-line"></div>
        <div class="splash-status">
          <span id="splashStatus">INITIALIZING SYSTEM</span>
          <span class="splash-cursor">_</span>
        </div>
        <button id="splashEnter" class="splash-enter">
          <span class="splash-enter-text">ENTER</span>
          <span class="splash-enter-sub">进入</span>
        </button>
      </div>
      <div class="splash-scanlines"></div>
    </div>

    <!-- Animated cyberpunk background -->
    <div class="cyber-bg" aria-hidden="true">
      <div class="cyber-bg__image"></div>
      <div class="cyber-bg__grid"></div>
      <div class="cyber-bg__gradient"></div>
      <!-- Floating particles -->
      <div class="cyber-bg__particle" style="left: 5%; width: 3px; height: 3px; background: rgba(0, 240, 255, 0.5); animation-duration: 12s; animation-delay: 0s;"></div>
      <div class="cyber-bg__particle" style="left: 15%; width: 2px; height: 2px; background: rgba(255, 45, 120, 0.4); animation-duration: 18s; animation-delay: 2s;"></div>
      <div class="cyber-bg__particle" style="left: 25%; width: 4px; height: 4px; background: rgba(191, 64, 255, 0.3); animation-duration: 15s; animation-delay: 5s;"></div>
      <div class="cyber-bg__particle" style="left: 35%; width: 2px; height: 2px; background: rgba(0, 240, 255, 0.4); animation-duration: 20s; animation-delay: 1s;"></div>
      <div class="cyber-bg__particle" style="left: 45%; width: 3px; height: 3px; background: rgba(57, 255, 20, 0.3); animation-duration: 14s; animation-delay: 7s;"></div>
      <div class="cyber-bg__particle" style="left: 55%; width: 2px; height: 2px; background: rgba(255, 45, 120, 0.5); animation-duration: 16s; animation-delay: 3s;"></div>
      <div class="cyber-bg__particle" style="left: 65%; width: 3px; height: 3px; background: rgba(191, 64, 255, 0.4); animation-duration: 19s; animation-delay: 6s;"></div>
      <div class="cyber-bg__particle" style="left: 75%; width: 2px; height: 2px; background: rgba(0, 240, 255, 0.3); animation-duration: 13s; animation-delay: 4s;"></div>
      <div class="cyber-bg__particle" style="left: 85%; width: 4px; height: 4px; background: rgba(57, 255, 20, 0.4); animation-duration: 17s; animation-delay: 8s;"></div>
      <div class="cyber-bg__particle" style="left: 92%; width: 2px; height: 2px; background: rgba(255, 45, 120, 0.3); animation-duration: 21s; animation-delay: 10s;"></div>
    </div>

    <!-- Cursor glow trail -->
    <div class="cursor-glow" id="cursorGlow" style="opacity: 0;" aria-hidden="true"></div>

    <!-- Page content (above background) -->
    <div class="relative z-10">
      <slot />
      <footer class="pl-0 lg:pl-[260px]">
        <div class="max-w-3xl mx-auto px-8 pb-16 pt-20">
          <div class="border-t border-[var(--color-border)] pt-8">
            <p class="text-xs text-[var(--color-text-muted)] tracking-widest font-light" style="font-family: 'Orbitron', sans-serif;">&copy; {new Date().getFullYear()} <span class="neon-cyan">coconut</span></p>
          </div>
        </div>
      </footer>
    </div>

    <!-- Cursor trail script -->
    <script>
      const glow = document.getElementById('cursorGlow');
      if (glow) {
        let visible = false;
        document.addEventListener('mousemove', (e) => {
          if (!visible) {
            glow.style.opacity = '1';
            visible = true;
          }
          glow.style.left = e.clientX + 'px';
          glow.style.top = e.clientY + 'px';
        });
        document.addEventListener('mouseleave', () => {
          glow.style.opacity = '0';
          visible = false;
        });
      }
    </script>
  
    <!-- Cyberpunk page transition -->
    <div id="pageTransition" class="page-transition" aria-hidden="true">
      <div class="transition-scanline"></div>
      <div class="transition-glitch-text" id="transitionText">LOADING</div>
    </div>

    <!-- Page transition script -->
    <script>
      // Page enter animation
      document.addEventListener('DOMContentLoaded', () => {
        const content = document.querySelector('.relative.z-10');
        if (content) {
          content.classList.add('page-enter');
          requestAnimationFrame(() => {
            content.classList.add('page-enter-active');
          });
        }
      });

      // Fix: clear transition overlay on back/forward navigation (bfcache)
      window.addEventListener('pageshow', (e) => {
        const overlay = document.getElementById('pageTransition');
        if (overlay) overlay.classList.remove('active');
      });

      // SPA-style navigation - no page reload, music keeps playing
      async function spaNavigate(href) {
        const overlay = document.getElementById('pageTransition');
        const text = document.getElementById('transitionText');
        const words = ['LOADING', 'ACCESSING', 'DECRYPTING', 'CONNECTING', 'SYNCING', 'ENTERING'];
        if (text) text.textContent = words[Math.floor(Math.random() * words.length)];
        if (overlay) overlay.classList.add('active');

        try {
          const resp = await fetch(href);
          const html = await resp.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          // Swap main content (everything inside .relative.z-10 except footer)
          const newContent = doc.querySelector('.relative.z-10');
          const oldContent = document.querySelector('.relative.z-10');
          if (newContent && oldContent) {
            oldContent.innerHTML = newContent.innerHTML;
          }

          // Update title
          document.title = doc.title;

          // Update URL
          history.pushState({}, '', href);

          // Re-run any inline scripts in new content
          oldContent?.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
              newScript.src = oldScript.src;
            } else {
              newScript.textContent = oldScript.textContent;
            }
            oldScript.replaceWith(newScript);
          });

          // Scroll to top
          window.scrollTo(0, 0);

        } catch (err) {
          // Fallback to normal navigation
          window.location.href = href;
          return;
        }

        // Fade out overlay
        setTimeout(() => {
          if (overlay) overlay.classList.remove('active');
          // Page enter animation
          const content = document.querySelector('.relative.z-10');
          if (content) {
            content.classList.remove('page-enter-active');
            content.classList.add('page-enter');
            requestAnimationFrame(() => {
              content.classList.add('page-enter-active');
            });
          }
        }, 300);
      }

      // Handle back/forward
      window.addEventListener('popstate', () => {
        spaNavigate(location.href);
      });

      // Intercept link clicks
      document.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;
        const href = link.getAttribute('href');
        if (!href || href.startsWith('#') || href.startsWith('http') || href.startsWith('mailto')) return;
        
        e.preventDefault();
        spaNavigate(href);
      });
    </script>
  
    <!-- Splash screen script -->
    <script>
      (function() {
        // Only show splash once per session
        if (sessionStorage.getItem('splash_done')) {
          const s = document.getElementById('splashScreen');
          if (s) s.remove();
          return;
        }

        const splash = document.getElementById('splashScreen');
        const statusEl = document.getElementById('splashStatus');
        const enterBtn = document.getElementById('splashEnter');
        if (!splash) return;

        // Prevent scrolling
        document.body.style.overflow = 'hidden';

        // Boot sequence messages
        const messages = [
          'INITIALIZING SYSTEM',
          'LOADING NEURAL INTERFACE',
          'CONNECTING TO DREAMSCAPE',
          'DECRYPTING MEMORIES',
          'SYNCING CONSCIOUSNESS',
          'SYSTEM READY'
        ];

        let msgIndex = 0;
        const msgInterval = setInterval(() => {
          msgIndex++;
          if (msgIndex < messages.length) {
            if (statusEl) statusEl.textContent = messages[msgIndex];
          }
          if (msgIndex >= messages.length - 1) {
            clearInterval(msgInterval);
            if (enterBtn) enterBtn.classList.add('visible');
          }
        }, 500);

        function enter() {
          sessionStorage.setItem('splash_done', '1');
          splash.classList.add('fade-out');
          document.body.style.overflow = '';
          
          // Try to autoplay music
          const audio = document.getElementById('audioPlayer');
          if (audio) {
            audio.play().then(() => {
              // Update play button
              const pb = document.getElementById('playPause');
              const pbm = document.getElementById('playPauseMobile');
              if (pb) pb.textContent = '⏸';
              if (pbm) pbm.textContent = '⏸';
              const player = document.querySelector('.music-player');
              if (player) player.classList.add('playing');
            }).catch(() => {});
          }

          setTimeout(() => splash.remove(), 800);
        }

        if (enterBtn) enterBtn.addEventListener('click', enter);
        document.addEventListener('keydown', function handler(e) {
          if (enterBtn && enterBtn.classList.contains('visible')) {
            enter();
            document.removeEventListener('keydown', handler);
          }
        });
      })();
    </script>
  </body>
</html>
